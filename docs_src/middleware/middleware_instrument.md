# Middleware 简述与分层设计

SAGE Middleware 提供一组面向 AI 推理的通用“服务与计算接口”，用于支撑上层应用在效果、效率与效能之间取得平衡。

## 为什么需要单独的 Middleware 层？

- 资源与硬件友好：聚焦底层硬件加速与资源利用，把复杂度下沉到中间件。
- 服务逻辑统一：通过服务化抽象，复用成熟能力，减少业务重复造轮子。
- 组合与编排：将组件以服务方式编排，形成从存储到检索的端到端路径。

## 分层结构（4 层）

1) API 层（接口）

	- 抽象服务接口：类似 map_function，用户通过继承基类实现自定义服务。
	- 计算接口：例如 SAGE Flow，对外提供可编程的计算与编排接口。

2) 服务层（Service）

	- 提供预定义服务，编排组件形成服务逻辑，对上暴露统一接口。
	- 示例：语料查询、长期记忆存储、向量检索等。

3) 组件层（Components）

	- 被动组件与引擎：非结构化数据库、向量计算引擎、Neuromem 等。
	- 作为服务的实现基石，由服务层进行组合与编排。

4) 硬件层（Hardware）

	- 面向各组件的硬件亲和后端：GPU 加速向量相似度、CXL 内存后端等。
	- 由组件/服务选择并绑定最优执行后端。

## 关于 SAGE DB 的角色

- SAGE DB 原生扩展：提供高性能的向量存储与检索能力，可通过 `sage extensions install sage_db` 构建。本质上是组件层的数据库引擎，服务层可将其包装成 Memory Service、语义检索服务等。
- 在 Function 中：通过 `call_service` 接口访问对应服务，即可透明地使用 GPU/多模态能力，调用前可使用 `sage extensions status` 确认扩展已启用。

## 关于 SAGE Flow 的位置与理解

- 单个 Flow 算子：其具体计算执行在“硬件层”；从职责看可视为“组件层”的一个 function。
- SAGE Flow 本身：属于“计算组件”，既可以被定义为服务（自定义或预定义），也可以向上直接提供计算接口。
