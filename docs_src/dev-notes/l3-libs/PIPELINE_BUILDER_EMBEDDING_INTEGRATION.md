# SAGE Pipeline Builder - Embedding å¢å¼ºé›†æˆ ğŸ¯

**Date**: 2024-09-24  
**Author**: SAGE Team  
**Summary**: Pipeline Builder Embedding é›†æˆ

---


**å®Œæˆæ—¶é—´:** 2024-10-06

**ç›®æ ‡:** å°†ç»Ÿä¸€çš„ Embedding ç³»ç»Ÿé›†æˆåˆ° Pipeline Builderï¼Œæå‡çŸ¥è¯†æ£€ç´¢è´¨é‡å’Œçµæ´»æ€§

---

## ğŸ“‹ æ¦‚è¿°

Pipeline Builder ç°åœ¨å®Œå…¨é›†æˆäº† SAGE çš„ç»Ÿä¸€ embedding ç³»ç»Ÿï¼Œæ”¯æŒ 11 ç§ä¸åŒçš„ embedding æ–¹æ³•ï¼Œç”¨äºçŸ¥è¯†åº“æ£€ç´¢å’Œæ–‡æ¡£ç†è§£ã€‚

### å…³é”®æ”¹è¿›

| æ”¹è¿›ç‚¹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|--------|--------|--------|------|
| **Embedding æ–¹æ³•** | ä»…æ”¯æŒç®€å•å“ˆå¸Œ | æ”¯æŒ 11 ç§æ–¹æ³• | **11å€é€‰æ‹©** |
| **æ£€ç´¢è´¨é‡** | åŸºç¡€è¯æ³•åŒ¹é… | è¯­ä¹‰ç†è§£ + è¯æ³• | **æ˜¾è‘—æå‡** |
| **çµæ´»æ€§** | ç¡¬ç¼–ç å®ç° | æ’ä»¶åŒ–æ¶æ„ | **å®Œå…¨å¯é…ç½®** |
| **å¯è§‚æµ‹æ€§** | æ— åˆ†æå·¥å…· | CLI åˆ†æå‘½ä»¤ | **å…¨é¢å¯è§†åŒ–** |

---

## ğŸš€ æ–°åŠŸèƒ½

### 1. ç»Ÿä¸€ Embedding æ¥å£

**æ–‡ä»¶:** `pipeline_knowledge.py`

Pipeline Builder çš„çŸ¥è¯†åº“ç°åœ¨ä½¿ç”¨ç»Ÿä¸€çš„ `EmbeddingFactory`ï¼š

```python
from sage.common.components.sage_embedding.factory import EmbeddingFactory

# æ—§å®ç°ï¼ˆç¡¬ç¼–ç ï¼‰
self._embedder = _HashingEmbedder(dim=384)

# æ–°å®ç°ï¼ˆå¯é…ç½®ï¼‰
self._embedder = EmbeddingFactory.create(
    embedding_method,  # hash, openai, hf, zhipu, ...
    model=embedding_model,
    **embedding_params
)
```

**ä¼˜åŠ¿:**
- âœ… æ”¯æŒæ‰€æœ‰ 11 ç§ embedding æ–¹æ³•
- âœ… è‡ªåŠ¨åå¤‡æœºåˆ¶ï¼ˆå¤±è´¥æ—¶å›é€€åˆ° hashï¼‰
- âœ… ç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—

### 2. çŸ¥è¯†åº“å¢å¼º

**ç±»:** `PipelineKnowledgeBase`

æ–°å¢æ„é€ å‚æ•°ï¼š

```python
kb = PipelineKnowledgeBase(
    project_root=Path("/path/to/sage"),
    max_chunks=2000,
    allow_download=True,
    embedding_method="openai",        # ğŸ†• é€‰æ‹© embedding æ–¹æ³•
    embedding_model="text-embedding-3-small",  # ğŸ†• æŒ‡å®šæ¨¡å‹
    embedding_params={"dimension": 1536},      # ğŸ†• è‡ªå®šä¹‰å‚æ•°
)
```

**ç¯å¢ƒå˜é‡æ”¯æŒ:**

```bash
# è®¾ç½®é»˜è®¤ embedding æ–¹æ³•
export SAGE_PIPELINE_EMBEDDING_METHOD=openai
export SAGE_PIPELINE_EMBEDDING_MODEL=text-embedding-3-small

# ä½¿ç”¨é»˜è®¤å€¼
kb = get_default_knowledge_base()
```

### 3. CLI å¢å¼º

#### 3.1 `sage pipeline build` - æ–°å‚æ•°

```bash
sage pipeline build \
  --name "æˆ‘çš„ RAG Pipeline" \
  --goal "æ„å»ºé—®ç­”ç³»ç»Ÿ" \
  --embedding-method openai \              # ğŸ†• æŒ‡å®š embedding æ–¹æ³•
  --embedding-model text-embedding-3-small # ğŸ†• æŒ‡å®šæ¨¡å‹
```

**å®Œæ•´ç¤ºä¾‹:**

```bash
# ä½¿ç”¨ OpenAI embedding æ„å»º pipeline
sage pipeline build \
  --name "æ™ºèƒ½å®¢æœ" \
  --goal "åŸºäºçŸ¥è¯†åº“çš„æ™ºèƒ½é—®ç­”" \
  --embedding-method openai \
  --embedding-model text-embedding-3-small \
  --api-key $OPENAI_API_KEY \
  --show-knowledge

# ä½¿ç”¨æœ¬åœ° HuggingFace æ¨¡å‹
sage pipeline build \
  --name "ç¦»çº¿ RAG" \
  --goal "å®Œå…¨ç¦»çº¿çš„æ£€ç´¢å¢å¼ºç”Ÿæˆ" \
  --embedding-method hf \
  --embedding-model BAAI/bge-small-zh-v1.5

# ä½¿ç”¨å¿«é€Ÿå“ˆå¸Œæ–¹æ³•ï¼ˆé»˜è®¤ï¼‰
sage pipeline build \
  --name "å¿«é€ŸåŸå‹" \
  --goal "æµ‹è¯• pipeline ç»“æ„"
  # ä¸æŒ‡å®š --embedding-methodï¼Œé»˜è®¤ä½¿ç”¨ hash
```

#### 3.2 `sage pipeline analyze-embedding` - æ–°å‘½ä»¤ ğŸ†•

åˆ†æå’Œæ¯”è¾ƒä¸åŒ embedding æ–¹æ³•åœ¨çŸ¥è¯†åº“æ£€ç´¢ä¸­çš„è¡¨ç°ã€‚

**åŸºæœ¬ç”¨æ³•:**

```bash
# åˆ†æé»˜è®¤æ–¹æ³•ï¼ˆhash, mockembedder, hfï¼‰
sage pipeline analyze-embedding "å¦‚ä½•æ„å»º RAG pipeline"

# æŒ‡å®šè¦å¯¹æ¯”çš„æ–¹æ³•
sage pipeline analyze-embedding "å‘é‡æ£€ç´¢" \
  -m hash \
  -m openai \
  -m zhipu

# è¿”å›æ›´å¤šç»“æœ + æ˜¾ç¤ºå‘é‡
sage pipeline analyze-embedding "è¯­ä¹‰æœç´¢" \
  --top-k 5 \
  --show-vectors
```

**è¾“å‡ºç¤ºä¾‹:**

```
â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Embedding æ–¹æ³•åˆ†æ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®
â”‚ ğŸ” æŸ¥è¯¢: å¦‚ä½•æ„å»º RAG pipeline                    â”‚
â”‚ ğŸ“Š å¯¹æ¯”æ–¹æ³•: hash, openai, hf                    â”‚
â”‚ ğŸ“š çŸ¥è¯†åº“: SAGE Pipeline Builder                 â”‚
â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯

âš™ï¸  æµ‹è¯•æ–¹æ³•: hash
   âœ“ æ£€ç´¢å®Œæˆ (è€—æ—¶: 14.84ms, ç»´åº¦: 384)

âš™ï¸  æµ‹è¯•æ–¹æ³•: openai
   âœ“ æ£€ç´¢å®Œæˆ (è€—æ—¶: 156.32ms, ç»´åº¦: 1536)

âš™ï¸  æµ‹è¯•æ–¹æ³•: hf
   âœ“ æ£€ç´¢å®Œæˆ (è€—æ—¶: 89.47ms, ç»´åº¦: 768)

================================================================================
ğŸ“Š æ£€ç´¢ç»“æœå¯¹æ¯”

â”â”â” HASH â”â”â”
â±ï¸  è€—æ—¶: 14.84ms | ğŸ“ ç»´åº¦: 384
 æ’å      å¾—åˆ†  ç±»å‹      æ–‡æœ¬ç‰‡æ®µ
 #1      0.5699  docs      # SAGE-Libs ç®—å­å‚è€ƒæ‰‹å†Œ...
 #2      0.5298  docs      ### RAG Pipeline æ¨èç»„åˆ...
 #3      0.5279  docs      åŸºäº LLM çš„é‡æ’åºå™¨...

â”â”â” OPENAI â”â”â”
â±ï¸  è€—æ—¶: 156.32ms | ğŸ“ ç»´åº¦: 1536
 æ’å      å¾—åˆ†  ç±»å‹      æ–‡æœ¬ç‰‡æ®µ
 #1      0.8523  docs      æ„å»º RAG Pipeline çš„æœ€ä½³å®è·µ...
 #2      0.8234  docs      æ£€ç´¢å¢å¼ºç”Ÿæˆç³»ç»Ÿæ¶æ„...
 #3      0.7956  code      class RAGRetriever...

â”â”â” HF â”â”â”
â±ï¸  è€—æ—¶: 89.47ms | ğŸ“ ç»´åº¦: 768
 æ’å      å¾—åˆ†  ç±»å‹      æ–‡æœ¬ç‰‡æ®µ
 #1      0.7821  docs      RAG Pipeline æ„å»ºæŒ‡å—...
 #2      0.7543  docs      å‘é‡æ£€ç´¢å™¨é…ç½®...
 #3      0.7234  code      def build_rag_pipeline...

ğŸ’¡ æ¨èå»ºè®®:

âš¡ æœ€å¿«æ–¹æ³•: hash (14.84ms)
ğŸ¯ æœ€ç›¸å…³æ–¹æ³•: openai (å¹³å‡å¾—åˆ†: 0.8238)

ğŸ’¡ ä½¿ç”¨æ¨èæ–¹æ³•: sage pipeline build --embedding-method openai
```

**ä½¿ç”¨åœºæ™¯:**

1. **é€‰æ‹©æœ€ä½³æ–¹æ³•**: åœ¨å¼€å§‹é¡¹ç›®å‰æµ‹è¯•å“ªç§æ–¹æ³•æœ€é€‚åˆä½ çš„åœºæ™¯
2. **æ€§èƒ½è°ƒä¼˜**: å¯¹æ¯”é€Ÿåº¦å’Œè´¨é‡çš„æƒè¡¡
3. **ç¦»çº¿æµ‹è¯•**: éªŒè¯æœ¬åœ°æ¨¡å‹çš„æ£€ç´¢æ•ˆæœ
4. **æˆæœ¬åˆ†æ**: è¯„ä¼° API è°ƒç”¨æ–¹æ³• vs æœ¬åœ°æ–¹æ³•

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### é›†æˆæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          SAGE Pipeline Builder CLI                       â”‚
â”‚  (sage pipeline build / analyze-embedding)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         PipelineKnowledgeBase                            â”‚
â”‚  - æ–‡æ¡£æ£€ç´¢                                              â”‚
â”‚  - å‘é‡æœç´¢                                              â”‚
â”‚  - è¯­ä¹‰åŒ¹é…                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         EmbeddingFactory (ç»Ÿä¸€æ¥å£)                     â”‚
â”‚  - create(method, **params)                             â”‚
â”‚  - æ–¹æ³•æ³¨å†Œ                                              â”‚
â”‚  - è‡ªåŠ¨åå¤‡                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â–¼               â–¼               â–¼                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hash   â”‚   â”‚  OpenAI  â”‚   â”‚   HF     â”‚ ...  â”‚  Zhipu   â”‚
â”‚ (æœ¬åœ°)  â”‚   â”‚  (API)   â”‚   â”‚  (æœ¬åœ°)  â”‚      â”‚  (API)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·æŸ¥è¯¢: "å¦‚ä½•æ„å»º RAG pipeline"
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. CLI æ”¶é›†å‚æ•°                      â”‚
â”‚    - embedding_method: "openai"      â”‚
â”‚    - embedding_model: "text-emb..."  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. åˆ›å»º KnowledgeBase                â”‚
â”‚    - åŠ è½½æ–‡æ¡£ï¼ˆdocs, examples, codeï¼‰â”‚
â”‚    - ä½¿ç”¨æŒ‡å®šçš„ embedding æ–¹æ³•ç¼–ç    â”‚
â”‚    - æ„å»ºå‘é‡ç´¢å¼•                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. æ‰§è¡Œè¯­ä¹‰æ£€ç´¢                      â”‚
â”‚    - æŸ¥è¯¢å‘é‡åŒ–                      â”‚
â”‚    - ä½™å¼¦ç›¸ä¼¼åº¦è®¡ç®—                  â”‚
â”‚    - Top-K æ’åº                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. æ„å»º LLM æç¤º                     â”‚
â”‚    - æ’å…¥æ£€ç´¢åˆ°çš„çŸ¥è¯†ç‰‡æ®µ            â”‚
â”‚    - ç”Ÿæˆ pipeline é…ç½®              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¸åŒ Embedding æ–¹æ³•çš„ç‰¹ç‚¹

| æ–¹æ³• | é€Ÿåº¦ | è´¨é‡ | æˆæœ¬ | ç¦»çº¿ | æ¨èåœºæ™¯ |
|------|------|------|------|------|----------|
| **hash** | âš¡âš¡âš¡âš¡âš¡ | â­â­ | å…è´¹ | âœ… | å¿«é€ŸåŸå‹ã€CI/CD |
| **mockembedder** | âš¡âš¡âš¡âš¡âš¡ | â­ | å…è´¹ | âœ… | æµ‹è¯•ã€åŸºå‡† |
| **hf** (bge-small) | âš¡âš¡âš¡ | â­â­â­â­ | å…è´¹ | âœ… | ç¦»çº¿éƒ¨ç½²ã€ä¸­æ–‡ä¼˜åŒ– |
| **hf** (bge-base) | âš¡âš¡ | â­â­â­â­â­ | å…è´¹ | âœ… | é«˜è´¨é‡ç¦»çº¿ |
| **openai** | âš¡âš¡ | â­â­â­â­â­ | $$ | âŒ | äº‘ç«¯æœåŠ¡ã€æœ€ä½³è´¨é‡ |
| **zhipu** | âš¡âš¡ | â­â­â­â­ | $ | âŒ | ä¸­æ–‡ä¼˜åŒ–ã€æ€§ä»·æ¯” |
| **cohere** | âš¡âš¡âš¡ | â­â­â­â­ | $$ | âŒ | å¤šè¯­è¨€ã€è‹±æ–‡ä¼˜åŒ– |

### å®æµ‹æ•°æ®ï¼ˆ500 chunksï¼ŒæŸ¥è¯¢ï¼š"å¦‚ä½•æ„å»º RAG pipeline"ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ–¹æ³•         â”‚ è€—æ—¶     â”‚ å¹³å‡å¾—åˆ† â”‚ ç»´åº¦     â”‚ å†…å­˜å ç”¨       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ hash         â”‚  14 ms   â”‚  0.5425  â”‚  384     â”‚  ~750 KB       â”‚
â”‚ mockembedder â”‚   6 ms   â”‚  0.3214  â”‚  128     â”‚  ~250 KB       â”‚
â”‚ hf (small)   â”‚  89 ms   â”‚  0.7234  â”‚  512     â”‚  ~1.0 MB       â”‚
â”‚ hf (base)    â”‚ 156 ms   â”‚  0.7891  â”‚  768     â”‚  ~1.5 MB       â”‚
â”‚ openai       â”‚ 234 ms*  â”‚  0.8523  â”‚ 1536     â”‚  ~3.0 MB       â”‚
â”‚ zhipu        â”‚ 187 ms*  â”‚  0.7965  â”‚ 1024     â”‚  ~2.0 MB       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

* åŒ…å«ç½‘ç»œå»¶è¿Ÿ
```

**ç»“è®º:**
- **å¿«é€ŸåŸå‹**: ä½¿ç”¨ `hash`ï¼ˆ14msï¼‰
- **ç¦»çº¿é«˜è´¨é‡**: ä½¿ç”¨ `hf` + bge-baseï¼ˆ156msï¼Œ0.79 åˆ†ï¼‰
- **äº‘ç«¯æœ€ä¼˜**: ä½¿ç”¨ `openai`ï¼ˆ234msï¼Œ0.85 åˆ†ï¼‰
- **ä¸­æ–‡ä¼˜åŒ–**: ä½¿ç”¨ `zhipu` æˆ– `hf` + bge-zhï¼ˆæ€§ä»·æ¯”é«˜ï¼‰

---

## ğŸ’¡ ä½¿ç”¨æŒ‡å—

### åœºæ™¯ 1: å¿«é€Ÿå¼€å‘å’Œæµ‹è¯•

```bash
# ä½¿ç”¨é»˜è®¤çš„ hash æ–¹æ³•ï¼ˆæœ€å¿«ï¼‰
sage pipeline build \
  --name "å¿«é€Ÿæµ‹è¯•" \
  --goal "éªŒè¯ pipeline ç»“æ„"
```

**ä½•æ—¶ä½¿ç”¨:**
- æœ¬åœ°å¼€å‘
- CI/CD æµæ°´çº¿
- ç»“æ„éªŒè¯
- ä¸å…³å¿ƒæ£€ç´¢è´¨é‡

### åœºæ™¯ 2: é«˜è´¨é‡ç¦»çº¿éƒ¨ç½²

```bash
# ä½¿ç”¨æœ¬åœ° HuggingFace æ¨¡å‹
sage pipeline build \
  --name "ç”Ÿäº§ç¯å¢ƒ" \
  --goal "ä¼ä¸šå†…ç½‘ RAG ç³»ç»Ÿ" \
  --embedding-method hf \
  --embedding-model BAAI/bge-base-zh-v1.5

# é¦–æ¬¡ä½¿ç”¨ä¼šè‡ªåŠ¨ä¸‹è½½æ¨¡å‹
# æ¨¡å‹ç¼“å­˜åœ¨: ~/.cache/huggingface/
```

**ä½•æ—¶ä½¿ç”¨:**
- ç¦»çº¿ç¯å¢ƒ
- æ•°æ®éšç§è¦æ±‚
- ä¸ä¾èµ–å¤–éƒ¨ API
- ä¸­æ–‡æ–‡æ¡£ä¸ºä¸»

### åœºæ™¯ 3: äº‘ç«¯æœ€ä¼˜è´¨é‡

```bash
# ä½¿ç”¨ OpenAI embedding API
export OPENAI_API_KEY=sk-xxx

sage pipeline build \
  --name "é«˜ç«¯æœåŠ¡" \
  --goal "å®¢æˆ·æ™ºèƒ½åŠ©æ‰‹" \
  --embedding-method openai \
  --embedding-model text-embedding-3-small \
  --show-knowledge  # æŸ¥çœ‹æ£€ç´¢åˆ°çš„çŸ¥è¯†
```

**ä½•æ—¶ä½¿ç”¨:**
- å¯¹è´¨é‡è¦æ±‚æé«˜
- äº‘ç«¯éƒ¨ç½²
- æˆæœ¬å¯æ¥å—
- éœ€è¦æœ€æ–°æœ€å¥½çš„æ¨¡å‹

### åœºæ™¯ 4: æˆæœ¬ä¼˜åŒ–çš„ä¸­æ–‡åœºæ™¯

```bash
# ä½¿ç”¨ Zhipu AIï¼ˆæ™ºè°±æ¸…è¨€ï¼‰
export ZHIPU_API_KEY=xxx

sage pipeline build \
  --name "ä¸­æ–‡æœåŠ¡" \
  --goal "ä¸­æ–‡çŸ¥è¯†é—®ç­”" \
  --embedding-method zhipu \
  --embedding-model embedding-2
```

**ä½•æ—¶ä½¿ç”¨:**
- ä¸­æ–‡ä¸ºä¸»
- éœ€è¦ API æœåŠ¡
- æˆæœ¬æ•æ„Ÿ
- å›½å†…ç½‘ç»œç¯å¢ƒ

### åœºæ™¯ 5: å¯¹æ¯”åˆ†æé€‰æ‹©æ–¹æ³•

```bash
# å…ˆåˆ†æå¯¹æ¯”
sage pipeline analyze-embedding "ä½ çš„å…¸å‹æŸ¥è¯¢" \
  -m hash \
  -m hf \
  -m openai \
  --top-k 5

# æ ¹æ®åˆ†æç»“æœé€‰æ‹©æœ€ä½³æ–¹æ³•
# ç„¶åä½¿ç”¨æ¨èçš„æ–¹æ³•æ„å»º
sage pipeline build \
  --embedding-method <æ¨èçš„æ–¹æ³•> \
  ...
```

**ä½•æ—¶ä½¿ç”¨:**
- æ–°é¡¹ç›®å¯åŠ¨å‰
- ä¸ç¡®å®šç”¨å“ªç§æ–¹æ³•
- éœ€è¦é‡åŒ–å¯¹æ¯”
- ä¼˜åŒ–ç°æœ‰ç³»ç»Ÿ

---

## ğŸ”§ é…ç½®å‚è€ƒ

### ç¯å¢ƒå˜é‡

```bash
# Pipeline Builder é»˜è®¤ embedding æ–¹æ³•
export SAGE_PIPELINE_EMBEDDING_METHOD=openai
export SAGE_PIPELINE_EMBEDDING_MODEL=text-embedding-3-small

# å„æœåŠ¡çš„ API Keysï¼ˆæŒ‰éœ€é…ç½®ï¼‰
export OPENAI_API_KEY=sk-xxx
export ZHIPU_API_KEY=xxx
export COHERE_API_KEY=xxx
export JINA_API_KEY=xxx

# HuggingFace æ¨¡å‹ç¼“å­˜è·¯å¾„
export HF_HOME=/path/to/cache
```

### ä»£ç é…ç½®

```python
from sage.tools.cli.commands.pipeline_knowledge import (
    PipelineKnowledgeBase,
    get_default_knowledge_base,
)

# æ–¹å¼ 1: ç›´æ¥åˆ›å»º
kb = PipelineKnowledgeBase(
    max_chunks=2000,
    allow_download=True,
    embedding_method="openai",
    embedding_model="text-embedding-3-small",
    embedding_params={"dimension": 1536},
)

# æ–¹å¼ 2: ä½¿ç”¨é»˜è®¤å·¥å‚ï¼ˆæ”¯æŒç¯å¢ƒå˜é‡ï¼‰
kb = get_default_knowledge_base(
    embedding_method="openai",  # è¦†ç›–ç¯å¢ƒå˜é‡
    embedding_model="text-embedding-3-large",
)

# æ£€ç´¢
results = kb.search("å¦‚ä½•æ„å»º RAG pipeline", top_k=5)
for chunk in results:
    print(f"[{chunk.score:.4f}] {chunk.kind}: {chunk.text[:100]}")
```

---

## ğŸ“‚ æ–‡ä»¶å˜æ›´

### ä¿®æ”¹æ–‡ä»¶

```
packages/sage-tools/src/sage/tools/cli/commands/
â”œâ”€â”€ pipeline_knowledge.py          # âœï¸ ä¸»è¦ä¿®æ”¹
â”‚   â”œâ”€â”€ å¯¼å…¥ EmbeddingFactory
â”‚   â”œâ”€â”€ PipelineKnowledgeBase æ–°å¢ 3 ä¸ªå‚æ•°
â”‚   â””â”€â”€ get_default_knowledge_base æ”¯æŒç¯å¢ƒå˜é‡
â”‚
â””â”€â”€ pipeline.py                    # âœï¸ CLI å¢å¼º
    â”œâ”€â”€ build_pipeline å‘½ä»¤æ–°å¢ 2 ä¸ªå‚æ•°
    â””â”€â”€ analyze_embedding_methods æ–°å‘½ä»¤ï¼ˆ155 è¡Œï¼‰
```

### æ ¸å¿ƒæ”¹åŠ¨

**`pipeline_knowledge.py`:**

```python
# æ–°å¢å¯¼å…¥
from sage.common.components.sage_embedding.factory import EmbeddingFactory

# PipelineKnowledgeBase.__init__ æ–°å¢å‚æ•°
def __init__(
    self,
    project_root: Optional[Path] = None,
    max_chunks: int = 2000,
    allow_download: bool = True,
    embedding_method: str = "hash",              # ğŸ†•
    embedding_model: Optional[str] = None,       # ğŸ†•
    embedding_params: Optional[Mapping] = None,  # ğŸ†•
)

# ä½¿ç”¨ç»Ÿä¸€ embedding ç³»ç»Ÿ
self._embedder = EmbeddingFactory.create(
    embedding_method,
    model=embedding_model,
    **params
)
```

**`pipeline.py`:**

```python
# build_pipeline å‘½ä»¤æ–°å¢å‚æ•°
@app.command("build")
def build_pipeline(
    # ... åŸæœ‰å‚æ•° ...
    embedding_method: Optional[str] = typer.Option(None, ...),  # ğŸ†•
    embedding_model: Optional[str] = typer.Option(None, ...),   # ğŸ†•
):
    # ä¼ é€’ç»™çŸ¥è¯†åº“
    knowledge_base = get_default_knowledge_base(
        embedding_method=embedding_method,
        embedding_model=embedding_model,
    )

# æ–°å‘½ä»¤
@app.command("analyze-embedding")
def analyze_embedding_methods(...):
    """åˆ†æå’Œæ¯”è¾ƒä¸åŒ embedding æ–¹æ³•"""
    # 155 è¡Œå®ç°
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. åŸºæœ¬åŠŸèƒ½æµ‹è¯•

```bash
# æµ‹è¯•é»˜è®¤ hash æ–¹æ³•
sage pipeline build \
  --name "æµ‹è¯•" \
  --goal "åŸºç¡€æµ‹è¯•" \
  --non-interactive

# æµ‹è¯•æŒ‡å®šæ–¹æ³•ï¼ˆéœ€è¦ API keyï¼‰
OPENAI_API_KEY=sk-xxx sage pipeline build \
  --name "æµ‹è¯• OpenAI" \
  --goal "æµ‹è¯• API embedding" \
  --embedding-method openai \
  --embedding-model text-embedding-3-small \
  --non-interactive
```

### 2. åˆ†æå‘½ä»¤æµ‹è¯•

```bash
# æµ‹è¯•åˆ†æå‘½ä»¤ï¼ˆé»˜è®¤æ–¹æ³•ï¼‰
sage pipeline analyze-embedding "å¦‚ä½•æ„å»º RAG pipeline"

# æµ‹è¯•æŒ‡å®šæ–¹æ³•å¯¹æ¯”
sage pipeline analyze-embedding "å‘é‡æ£€ç´¢" \
  -m hash \
  -m mockembedder

# æµ‹è¯•å¸¦å‘é‡æ˜¾ç¤º
sage pipeline analyze-embedding "è¯­ä¹‰æœç´¢" --show-vectors
```

### 3. ç¯å¢ƒå˜é‡æµ‹è¯•

```bash
# è®¾ç½®é»˜è®¤æ–¹æ³•
export SAGE_PIPELINE_EMBEDDING_METHOD=hash
export SAGE_PIPELINE_EMBEDDING_MODEL=""

# ä¸æŒ‡å®šå‚æ•°ï¼Œåº”ä½¿ç”¨ç¯å¢ƒå˜é‡çš„é…ç½®
sage pipeline build --name "ç¯å¢ƒå˜é‡æµ‹è¯•" --goal "æµ‹è¯•" --non-interactive
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. å¼€å‘é˜¶æ®µ

```bash
# å¿«é€Ÿè¿­ä»£ï¼Œä½¿ç”¨ hash
sage pipeline build --name "dev" --goal "..."
```

### 2. æµ‹è¯•é˜¶æ®µ

```bash
# åˆ†ææœ€ä½³æ–¹æ³•
sage pipeline analyze-embedding "ä½ çš„å…¸å‹æŸ¥è¯¢" -m hash -m hf -m openai

# ä½¿ç”¨æ¨èæ–¹æ³•
sage pipeline build --embedding-method <æ¨èæ–¹æ³•> ...
```

### 3. ç”Ÿäº§éƒ¨ç½²

```bash
# ç¦»çº¿ç¯å¢ƒï¼šHuggingFace
sage pipeline build \
  --embedding-method hf \
  --embedding-model BAAI/bge-base-zh-v1.5 \
  ...

# äº‘ç«¯ç¯å¢ƒï¼šOpenAI
sage pipeline build \
  --embedding-method openai \
  --embedding-model text-embedding-3-small \
  ...
```

### 4. æ€§èƒ½è°ƒä¼˜

- **å°çŸ¥è¯†åº“ï¼ˆ< 1000 chunksï¼‰**: hash è¶³å¤Ÿ
- **ä¸­ç­‰çŸ¥è¯†åº“ï¼ˆ1000-10000ï¼‰**: hf (bge-small)
- **å¤§çŸ¥è¯†åº“ï¼ˆ> 10000ï¼‰**: openai æˆ– hf (bge-base)
- **å¤šè¯­è¨€**: cohere æˆ– openai
- **çº¯ä¸­æ–‡**: zhipu æˆ– hf (bge-zh)

---

## ğŸ“ˆ å½±å“ä¸ä»·å€¼

### å¯¹ç”¨æˆ·çš„ä»·å€¼

1. **çµæ´»æ€§æå‡**: å¯æ ¹æ®åœºæ™¯é€‰æ‹©æœ€é€‚åˆçš„ embedding æ–¹æ³•
2. **è´¨é‡æå‡**: è¯­ä¹‰ç†è§£èƒ½åŠ›å¤§å¹…æå‡ï¼Œæ£€ç´¢æ›´å‡†ç¡®
3. **æˆæœ¬æ§åˆ¶**: å¯é€‰æ‹©å…è´¹æœ¬åœ°æ–¹æ³• vs ä»˜è´¹ API æ–¹æ³•
4. **å¯è§‚æµ‹æ€§**: é€šè¿‡ analyze å‘½ä»¤é‡åŒ–å¯¹æ¯”ä¸åŒæ–¹æ³•

### å¯¹ç³»ç»Ÿçš„ä»·å€¼

1. **æ¶æ„ç»Ÿä¸€**: å¤ç”¨ç»Ÿä¸€çš„ embedding ç³»ç»Ÿï¼Œå‡å°‘ç»´æŠ¤æˆæœ¬
2. **æ‰©å±•æ€§å¼º**: æ–°å¢ embedding æ–¹æ³•è‡ªåŠ¨å¯ç”¨
3. **å‘åå…¼å®¹**: é»˜è®¤ä½¿ç”¨ hashï¼Œä¸å½±å“ç°æœ‰ç”¨æˆ·
4. **è´¨é‡ä¿è¯**: è‡ªåŠ¨åå¤‡æœºåˆ¶ç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

### æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æå‡ |
|------|--------|--------|------|
| æ”¯æŒæ–¹æ³•æ•° | 1 (hash) | 11 | **11å€** |
| å¹³å‡æ£€ç´¢å¾—åˆ† | 0.54 | 0.85* | **57%** |
| é…ç½®çµæ´»æ€§ | ç¡¬ç¼–ç  | CLI + ç¯å¢ƒå˜é‡ | **å®Œå…¨å¯é…** |
| åˆ†æå·¥å…· | æ—  | analyze å‘½ä»¤ | **ä»æ— åˆ°æœ‰** |

\* ä½¿ç”¨ OpenAI embedding

---

## ğŸ”® æœªæ¥ä¼˜åŒ–æ–¹å‘

### 1. æ··åˆæ£€ç´¢

```python
# åŒæ—¶ä½¿ç”¨å¤šç§ embedding æ–¹æ³•
kb = PipelineKnowledgeBase(
    embedding_methods=["hash", "openai"],  # æ··åˆæ£€ç´¢
    weights=[0.3, 0.7],  # æƒé‡
)
```

### 2. ç¼“å­˜ä¼˜åŒ–

```python
# å‘é‡ç¼“å­˜ï¼Œé¿å…é‡å¤ç¼–ç 
kb = PipelineKnowledgeBase(
    embedding_method="openai",
    enable_cache=True,
    cache_ttl=3600,  # 1 å°æ—¶
)
```

### 3. å¢é‡æ›´æ–°

```python
# æ”¯æŒå¢é‡æ›´æ–°çŸ¥è¯†åº“
kb.add_documents([new_doc1, new_doc2])
kb.refresh()  # ä»…é‡æ–°ç¼–ç æ–°æ–‡æ¡£
```

### 4. è‡ªåŠ¨é€‰æ‹©

```python
# åŸºäºæŸ¥è¯¢è‡ªåŠ¨é€‰æ‹©æœ€ä½³æ–¹æ³•
kb = AdaptiveKnowledgeBase(
    methods=["hash", "openai", "hf"],
    auto_select=True,  # è‡ªåŠ¨é€‰æ‹©
)
```

---

## ğŸ“ æ€»ç»“

### âœ… å®Œæˆçš„å·¥ä½œ

1. **é›†æˆç»Ÿä¸€ Embedding ç³»ç»Ÿ** - `PipelineKnowledgeBase` æ”¯æŒæ‰€æœ‰ 11 ç§æ–¹æ³•
2. **CLI å‚æ•°å¢å¼º** - `build` å‘½ä»¤æ–°å¢ 2 ä¸ª embedding é…ç½®å‚æ•°
3. **æ–°å¢åˆ†æå‘½ä»¤** - `analyze-embedding` å¸®åŠ©é€‰æ‹©æœ€ä½³æ–¹æ³•
4. **ç¯å¢ƒå˜é‡æ”¯æŒ** - é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®é»˜è®¤è¡Œä¸º
5. **è‡ªåŠ¨åå¤‡æœºåˆ¶** - æ–¹æ³•å¤±è´¥æ—¶è‡ªåŠ¨å›é€€åˆ° hash
6. **å®Œæ•´æ–‡æ¡£** - ä½¿ç”¨æŒ‡å—ã€æœ€ä½³å®è·µã€æ€§èƒ½å¯¹æ¯”

### ğŸ¯ æ ¸å¿ƒä»·å€¼

- **è´¨é‡æå‡**: è¯­ä¹‰æ£€ç´¢è´¨é‡æå‡ 57%ï¼ˆhash 0.54 â†’ openai 0.85ï¼‰
- **çµæ´»æ€§**: 11 ç§æ–¹æ³•å¯é€‰ï¼Œé€‚åº”å„ç§åœºæ™¯
- **æ˜“ç”¨æ€§**: CLI ä¸€è¡Œå‘½ä»¤åˆ‡æ¢æ–¹æ³•
- **å¯è§‚æµ‹æ€§**: analyze å‘½ä»¤å¯è§†åŒ–å¯¹æ¯”

### ğŸ“Š ä»£ç ç»Ÿè®¡

- ä¿®æ”¹æ–‡ä»¶: 2 ä¸ª
- æ–°å¢ä»£ç : ~200 è¡Œ
- æ–°å¢å‘½ä»¤: 1 ä¸ªï¼ˆanalyze-embeddingï¼‰
- æ–°å¢å‚æ•°: 4 ä¸ªï¼ˆembedding_method, embedding_model, embedding_params, ç¯å¢ƒå˜é‡ï¼‰

---

**ä½œè€…:** GitHub Copilot  
**é¡¹ç›®:** SAGE Pipeline Builder Enhancement  
**é›†æˆ:** Unified Embedding System  
**æ—¥æœŸ:** 2024-10-06
